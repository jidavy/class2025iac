pipeline {
    agent any
    
    parameters {
        choice(
            name: 'DEPLOYMENT_TARGET',
            choices: ['all', 'web-only', 'python-only', 'java-only'],
            description: 'Select which application to deploy'
        )
        choice(
            name: 'DEPLOYMENT_ACTION',
            choices: ['install', 'deploy', 'both'],
            description: 'Install (first time) or Deploy (update code)'
        )
    }
    
    environment {
        AWS_ACCESS_KEY_ID = credentials('aws-access-key-id')
        AWS_SECRET_ACCESS_KEY = credentials('aws-secret-access-key')
        AWS_DEFAULT_REGION = 'us-east-1'
    }
    
    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
                echo "Code checked out successfully"
            }
        }
        
        stage('Initialize Terraform') {
            steps {
                dir('terraform') {
                    sh '''
                        echo "Initializing Terraform Backend"
                        terraform init -reconfigure
                        echo "Terraform initialized successfully"
                    '''
                }
            }
        }
        
        stage('Get Infrastructure IPs') {
            steps {
                script {
                    dir('terraform') {
                        env.WEB_IP = sh(
                            script: "terraform output -raw web_node_public_ip",
                            returnStdout: true
                        ).trim()
                        
                        env.PYTHON_IP = sh(
                            script: "terraform output -raw python_node_public_ip",
                            returnStdout: true
                        ).trim()
                        
                        env.JAVA_IP = sh(
                            script: "terraform output -raw java_node_public_ip",
                            returnStdout: true
                        ).trim()
                        
                        echo "Infrastructure IPs Retrieved"
                        echo "Web Node IP: ${env.WEB_IP}"
                        echo "Python Node IP: ${env.PYTHON_IP}"
                        echo "Java Node IP: ${env.JAVA_IP}"
                    }
                }
            }
        }
        
        stage('Deploy Web Application') {
            when {
                anyOf {
                    expression { params.DEPLOYMENT_TARGET == 'all' }
                    expression { params.DEPLOYMENT_TARGET == 'web-only' }
                }
            }
            steps {
                sshagent(credentials: ['AWS-SSH-KEY']) {
                    sh """
                        echo "Deploying to Web Node: ${env.WEB_IP}"
                        scp -o StrictHostKeyChecking=no scripts/install-web.sh ec2-user@${env.WEB_IP}:/tmp/
                        ssh -o StrictHostKeyChecking=no ec2-user@${env.WEB_IP} 'chmod +x /tmp/install-web.sh && /tmp/install-web.sh'
                        echo "Web deployment completed"
                    """
                }
            }
        }
        
        stage('Deploy Python Application') {
            when {
                anyOf {
                    expression { params.DEPLOYMENT_TARGET == 'all' }
                    expression { params.DEPLOYMENT_TARGET == 'python-only' }
                }
            }
            steps {
                sshagent(credentials: ['AWS-SSH-KEY']) {
                    sh """
                        echo "Deploying to Python Node: ${env.PYTHON_IP}"
                        scp -o StrictHostKeyChecking=no scripts/install-python.sh ec2-user@${env.PYTHON_IP}:/tmp/
                        ssh -o StrictHostKeyChecking=no ec2-user@${env.PYTHON_IP} 'chmod +x /tmp/install-python.sh && /tmp/install-python.sh'
                        echo "Python deployment completed"
                    """
                }
            }
        }
        
        stage('Deploy Java Application') {
            when {
                anyOf {
                    expression { params.DEPLOYMENT_TARGET == 'all' }
                    expression { params.DEPLOYMENT_TARGET == 'java-only' }
                }
            }
            steps {
                sshagent(credentials: ['AWS-SSH-KEY']) {
                    sh """
                        echo "Deploying to Java Node: ${env.JAVA_IP}"
                        scp -o StrictHostKeyChecking=no scripts/install-java.sh ec2-user@${env.JAVA_IP}:/tmp/
                        ssh -o StrictHostKeyChecking=no ec2-user@${env.JAVA_IP} 'chmod +x /tmp/install-java.sh && /tmp/install-java.sh'
                        echo "Java deployment completed"
                    """
                }
            }
        }
        
        stage('Verify Deployments') {
            steps {
                script {
                    echo "Verifying Deployments"
                    if (params.DEPLOYMENT_TARGET == 'all' || params.DEPLOYMENT_TARGET == 'web-only') {
                        sh "curl -f http://${env.WEB_IP} || echo 'Web verification failed'"
                    }
                    if (params.DEPLOYMENT_TARGET == 'all' || params.DEPLOYMENT_TARGET == 'python-only') {
                        sh "curl -f http://${env.PYTHON_IP}:8080 || echo 'Python verification failed'"
                    }
                    if (params.DEPLOYMENT_TARGET == 'all' || params.DEPLOYMENT_TARGET == 'java-only') {
                        sh "curl -f http://${env.JAVA_IP}:9090 || echo 'Java verification failed'"
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo "Deployment Pipeline Completed Successfully"
            echo "Web: http://${env.WEB_IP}"
            echo "Python: http://${env.PYTHON_IP}:8080"
            echo "Java: http://${env.JAVA_IP}:9090"
        }
        failure {
            echo "Deployment pipeline failed - check logs above"
        }
    }
}
