pipeline {
    agent any
    
    parameters {
        choice(
            name: 'DEPLOYMENT_TARGET',
            choices: ['all', 'web-only', 'python-only', 'java-only'],
            description: 'Select which application to deploy'
        )
        choice(
            name: 'DEPLOYMENT_ACTION',
            choices: ['install', 'deploy', 'both'],
            description: 'Install (first time) or Deploy (update code)'
        )
    }
    
    environment {
        AWS_ACCESS_KEY_ID = credentials('aws-access-key-id')
        AWS_SECRET_ACCESS_KEY = credentials('aws-secret-access-key')
        AWS_DEFAULT_REGION = 'us-east-1'  // YOUR REGION - KEEPING IT
    }
    
    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
                echo "✅ Code checked out successfully"
            }
        }
        
        // NEW STAGE - This fixes the terraform init error
        stage('Initialize Terraform') {
            steps {
                dir('terraform') {
                    sh '''
                        echo "=== Initializing Terraform Backend ==="
                        terraform init -reconfigure
                        echo "✅ Terraform initialized successfully"
                    '''
                }
            }
        }
        
        stage('Get Infrastructure IPs') {
            steps {
                script {
                    dir('terraform') {
                        // Get IPs from Terraform outputs
                        env.WEB_IP = sh(
                            script: "terraform output -raw web_node_public_ip",
                            returnStdout: true
                        ).trim()
                        
                        env.PYTHON_IP = sh(
                            script: "terraform output -raw python_node_public_ip",
                            returnStdout: true
                        ).trim()
                        
                        env.JAVA_IP = sh(
                            script: "terraform output -raw java_node_public_ip",
                            returnStdout: true
                        ).trim()
                        
                        echo "================================================"
                        echo "Infrastructure IPs Retrieved:"
                        echo "Web Node IP: ${env.WEB_IP}"
                        echo "Python Node IP: ${env.PYTHON_IP}"
                        echo "Java Node IP: ${env.JAVA_IP}"
                        echo "================================================"
                    }
                }
            }
        }
        
        stage('Deploy Web Application') {
            when {
                anyOf {
                    expression { params.DEPLOYMENT_TARGET == 'all' }
                    expression { params.DEPLOYMENT_TARGET == 'web-only' }
                }
            }
            steps {
                sshagent(credentials: ['AWS-SSH-KEY']) {
                    sh """
                        echo "=== Deploying to Web Node: ${env.WEB_IP} ==="
                        
                        # Copy deployment script to remote server
                        scp -o StrictHostKeyChecking=no scripts/install-web.sh ec2-user@${env.WEB_IP}:/tmp/
                        
                        # Execute deployment script remotely
                        ssh -o StrictHostKeyChecking=no ec2-user@${env.WEB_IP} '
                            chmod +x /tmp/install-web.sh
                            /tmp/install-web.sh
                        '
                        
                        echo "✅ Web deployment completed!"
                    """
                }
            }
        }
        
        stage('Deploy Python Application') {
            when {
                anyOf {
                    expression { params.DEPLOYMENT_TARGET == 'all' }
                    expression { params.DEPLOYMENT_TARGET == 'python-only' }
                }
            }
            steps {
                sshagent(credentials: ['AWS-SSH-KEY']) {
                    sh """
                        echo "=== Deploying to Python Node: ${env.PYTHON_IP} ==="
                        
                        # Copy deployment script
                        scp -o StrictHostKeyChecking=no scripts/install-python.sh ec2-user@${env.PYTHON_IP}:/tmp/
                        
                        # Execute deployment
                        ssh -o StrictHostKeyChecking=no ec2-user@${env.PYTHON_IP} '
                            chmod +x /tmp/install-python.sh
                            /tmp/install-python.sh
                        '
                        
                        echo "✅ Python deployment completed!"
                    """
                }
            }
        }
        
        stage('Deploy Java Application') {
            when {
                anyOf {
                    expression { params.DEPLOYMENT_TARGET == 'all' }
                    expression { params.DEPLOYMENT_TARGET == 'java-only' }
                }
            }
            steps {
                sshagent(credentials: ['AWS-SSH-KEY']) {
                    sh """
                        echo "=== Deploying to Java Node: ${env.JAVA_IP} ==="
                        
                        # Copy deployment script
                        scp -o StrictHostKeyChecking=no scripts/install-java.sh ec2-user@${env.JAVA_IP}:/tmp/
                        
                        # Execute deployment
                        ssh -o StrictHostKeyChecking=no ec2-user@${env.JAVA_IP} '
                            chmod +x /tmp/install-java.sh
                            /tmp/install-java.sh
