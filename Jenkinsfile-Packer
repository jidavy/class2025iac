pipeline {
    agent any

    parameters {
        choice(
            name: 'PACKER_ACTION',
            choices: ['validate', 'build', 'build-nginx-only', 'build-java-python-only'],
            description: 'Select Packer action to perform'
        )
    }

    environment {
        AWS_SECRET_ACCESS_KEY = credentials('aws-secret-access-key')
        AWS_ACCESS_KEY_ID     = credentials('aws-access-key-id')
        AWS_DEFAULT_REGION    = 'eu-west-1'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                echo "✅ Code checked out successfully"
            }
        }

        stage('Verify Packer Installation') {
            steps {
                sh '''
                    echo "=== Checking Packer version ==="
                    packer version
                '''
            }
        }

        stage('Packer Init') {
            steps {
                dir('packer') {
                    sh '''
                        echo "=== Initializing Packer ==="
                        packer init .
                    '''
                }
            }
        }

        stage('Packer Validate') {
            steps {
                dir('packer') {
                    sh '''
                        echo "=== Validating Packer template ==="
                        packer validate .
                    '''
                }
            }
        }

        stage('Packer Build - NGINX AMI') {
            when {
                anyOf {
                    expression { params.PACKER_ACTION == 'build' }
                    expression { params.PACKER_ACTION == 'build-nginx-only' }
                }
            }
            steps {
                dir('packer') {
                    sh '''
                        echo "=== Building NGINX + Git AMI ==="
                        packer build -only='nginx-git-ami-build.*' .
                    '''
                }
            }
        }

        stage('Packer Build - Java/Python AMI') {
            when {
                anyOf {
                    expression { params.PACKER_ACTION == 'build' }
                    expression { params.PACKER_ACTION == 'build-java-python-only' }
                }
            }
            steps {
                dir('packer') {
                    sh '''
                        echo "=== Building Java + Python + Git AMI ==="
                        packer build -only='java-python-git-ami-build.*' .
                    '''
                }
            }
        }

        stage('List Created AMIs') {
            when {
                expression { params.PACKER_ACTION == 'build' }
            }
            steps {
                sh '''
                    echo "=== Listing AMIs created in last 10 minutes ==="
                    aws ec2 describe-images \
                        --owners self \
                        --filters "Name=creation-date,Values=$(date -u -d '10 minutes ago' '+%Y-%m-%dT%H:%M')*" \
                        --query 'Images[*].[ImageId,Name,CreationDate]' \
                        --output table
                '''
            }
        }
    }

    post {
        success {
            echo "✅ Packer pipeline completed successfully!"
            echo "Next step: Update dev.tfvars with new AMI IDs"
        }
        failure {
            echo "❌ Packer pipeline failed. Check logs above."
        }
    }
}
